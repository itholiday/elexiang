<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no" />
	<title>e乐享</title>
	<link rel="stylesheet" type="text/css" href="../css/aui.css" />
	<link rel="stylesheet" type="text/css" href="../css/login.css" />
	<style>
		.aui-card-list-footer {
			text-align: center;
			margin: 0 auto;
			margin-top: 1rem;
			padding: 0 2.5rem;
		}

		.aui-card-list-footer img {
			width: 2rem;
			text-align: center;
			margin: 0 auto;
		}

		.fx-yijiandengl {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			margin: 0;
		}
	</style>
</head>

<body>
	<div class="aui-content aui-margin-b-15 fx-yejian-by" style="padding-top: 50px;">
		<ul class="aui-list aui-form-list" id="login-1">
			<li class="aui-list-item" id="mobile">
				<div class="aui-list-item-inner">
					<div class="aui-list-item-input">
						<input type="tel" placeholder="输入手机号" value="">
					</div>
				</div>
			</li>
			<li class="aui-list-item" id="yzm">
				<div class="aui-list-item-inner">
					<div class="aui-list-item-input">
						<input type="password" placeholder="请输入密码" value="">
					</div>
					<!--<div class="aui-list-item-label-icon fx-yzm" >
						获取验证码
						</div>-->
				</div>
			</li>
		</ul>
		<ul class="aui-list aui-form-list" id="login-2" style="display: none">
			<li class="aui-list-item" id="mobile">
				<div class="aui-list-item-inner">
					<div class="aui-list-item-input">
						<input type="tel" placeholder="输入手机号">
					</div>
				</div>
			</li>
			<li class="aui-list-item" id="pwa">
				<div class="aui-list-item-inner">
					<div class="aui-list-item-input">
						<input type="password" placeholder="请输入密码">
					</div>
					<div class="aui-list-item-label-icon fx-yzm" style="color: #212121 !important;width: 90px !important;">
						忘记密码？
					</div>
				</div>
			</li>
		</ul>
	</div>
	<div class="aui-content aui-margin-b-15 fx-login fx-yejian-by">
		<div class="aui-btn aui-btn-danger aui-btn-block aui-btn-sm" Tapmode onclick="login()">
			登录
		</div>
		<div class="fx-login-b">
			<span class="aui-pull-left" Tapmode onclick="_url({url:'reg',title:'手机注册'})">手机注册</span><span class="aui-pull-right" Tapmode onclick="_url({url:'pwd',title:'密码重置'})">密码重置</span>
		</div>
	</div>
	<!-- <div class="aui-content fx-b fx-yejian-by fx-yijiandengl" style=" display:none ">
		<div class="fx-shanghuaxian"></div>
		<div class="fx-b-title">
			一键登录
		</div>
		<div class="aui-card-list-footer">

		</div>

	</div> -->
</body>
<script type="text/javascript" src="../script/fastclick.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/app.js"></script>
<script type="text/javascript">
	apiready = function() {
		FastClick.attach(document.body)
		hide()
	};
	function hide() {
		var _config = $api.getStorage('config').config;

		var login = $api.getStorage('config').login;
		if (!_config.appurl) {
			var html = '';
			for (var i = 0; i < login.length; i++) {
				html += '<div tapmode data-id="' + login[i].type + '">';
				html += '<img src="../image/' + login[i].type + '.png" />';
				html += '<div class="aui-grid-label">' + login[i].title + '</div></div>'
			}
			$('.aui-card-list-footer').html(html);
			$('.fx-yijiandengl').removeAttr('style');
			$('.aui-card-list-footer div').click(function() {

				var id = $(this).data('id');
				_loginTyle(id)
			})
		}


		FastClick.attach(document.body)
	}

	function login() {
		var type = $('.fx-top .aui-row div.chait').data('id')
		type = 1
		if (type == 1) {
			var username = $('#login-1 #mobile input').val();
			var password = $('#login-1 #yzm input').val();
			if (!_isMobile(username)) {
				_msg('手机号码不正确！')
				return;
			}
			if (!yzm) {
				_msg('请输入验证码！')
				return;
			}
		} else {
			var username = $('#login-2 #mobile input').val();
			var password = $('#login-2 #yzm input').val();
			if (!_isMobile(username)) {
				_msg('手机号码不正确！')
				return;
			}
			if (!pwa) {
				_msg('请输入密码！')
				return;
			}
		}
		_loading();
		_ajax('login/login', function(ret, err) {
			if (ret) {
				if (ret.status == 1) {
					_loadingCloes()
					$api.setStorage('token', ret.data.auth);
					console.log(ret.data.auth)
					$api.setStorage('user', ret.data.user);
					_close()
					return;
					_msg('登录成功')
					setTimeout(function() {
						_close()
					}, 1000)
				} else {
					_loadingCloes()
					_msg(ret.msg)
				}
			} else {
				_loadingCloes()
				_msg(ret.msg)
				console.log(JSON.stringify(err));
			}
		}, {
			phone: username,
			password: password
		})
	}
	// 封装ajax登录获取token
	function _login(openid, type, nickname, img) {
		_ajax('member/info', function(rets, errs) {
			if (rets.data) {
				_loadingCloes();
				$api.setStorage('user', ret.data);
				_msg('登录成功')
				setTimeout(function() {
					_hone()
				}, 1000)
			} else {
				_loadingCloes()
				_alert(rets.err)
			}
		},null,{auth:$api.getStorage('token')})
	}
	// 第三方登录
	function _loginTyle(type) {

		if (type == 'wx') {
			var wx = api.require('wx');
			wx.isInstalled(function(ret, err) {
				if (ret.installed) {
					wx.auth({}, function(reta, erra) {
						if (reta.status) {
							wx.getToken({
								code: reta.code
							}, function(retg, errg) {
								if (retg.status) {
									wx.getUserInfo({
										accessToken: retg.accessToken,
										openId: retg.openId
									}, function(retw, errw) {
										if (retw.status) {
											var openid = retw.openid //唯一识别ID
											if (openid) {
												//alert('ret:'+JSON.stringify(retw)+"\r\nerr:"+JSON.stringify(errw))
												_loginToken({
													type: 'wxapp',
													openid: retw.openid,
													img: retw.headimgurl,
													nickname: retw.nickname,
													info: retw
												})
											} else {
												_loadingCloes();
												_alert('openId值为空')
											}
										} else {
											_loadingCloes();
											if (errw.code == '-1') {
												_alert('未知错误：' + errw.code)
											} else if (errw.code == '1') {
												_alert('accessToken 过期')
											} else if (errw.code == '2') {
												_alert('openId非法')
											} else if (errw.code == '3') {
												_alert('openId值为空')
											} else if (errw.code == '4') {
												_alert('accessToken值为空')
											} else if (errw.code == '5') {
												_alert('accessToken非法')
											} else if (errw.code == '6') {
												_alert('网络超时')
											} else {
												_alert('未知错误：' + errw.code)
											}
										}
									});
								} else {
									_loadingCloes();
									if (errg.code == '-1') {
										_alert('未知错误：' + errg.code)
									} else if (errg.code == '1') {
										_alert('apiKey值为空或非法')
									} else if (errg.code == '2') {
										_alert('apiSecret值为空或非法')
									} else if (errg.code == '3') {
										_alert('code值为空或非法')
									} else if (errg.code == '4') {
										_alert('网络超时')
									} else {
										_alert('未知错误：' + errg.code)
									}
								}
							});
						} else {
							_loadingCloes();
							if (erra.code == '-1') {
								_alert('未知错误:' + erra.code)
							} else if (erra.code == '1') {
								_alert('取消登录')
							} else if (erra.code == '2') {
								_alert('拒绝授权登录')
							} else if (erra.code == '3') {
								_alert('当前设备未安装微信客户端')
							} else {
								_alert('未知错误:' + erra.code)
							}
						}
					});
				} else {
					_loadingCloes();
					_alert('当前设备未安装微信客户端')
				}
			});
		} else if (type == 'qq') {
			var qq = api.require('qq');
			qq.installed(function(ret, err) {
				if (ret.status) {
					qq.login(function(retl, errl) {
						if (retl.status) {
							qq.getUserInfo(function(retg, errg) {
								var openid = retl.openId;
								if (openid && retg.status) {
									_loginToken({
										type: 'qqapp',
										openid: openid,
										img: retg.info.figureurl_qq_2,
										nickname: retg.info.nickname,
										info: retg.info
									})
								} else {
									_loadingCloes();
									_alert('获取QQ资料失败')
								}
							});
						} else {
							_loadingCloes();
							_alert('取消登录')
						}
					});
				} else {
					_loadingCloes();
					_alert('当前设备未安装QQ客户端')
				}
			});
		} else if (type == 'wb') {
			var weibo = api.require('weibo');
			weibo.isInstalled(function(ret) {
				if (ret.status) {
					weibo.auth(function(reta, erra) {
						if (reta) {
							if (reta.status) {
								weibo.getUserInfo({
									token: reta.token,
									userId: reta.userId
								}, function(retg, errg) {
									if (retg.status) {
										var openid = retg.userInfo.id
										var img = retg.userInfo.avatar_large
										var nickname = retg.userInfo.name
										var info = retg.userInfo
										if (openid) {
											_loginToken({
												type: 'wbapp',
												openid: openid,
												img: img,
												nickname: nickname,
												info: info
											})
										} else {
											_loadingCloes();
											_alert('openId值为空')
										}
									} else {
										if (errg.err == '-1') {
											_alert('token 或 userId 非法')
										} else if (errg.err == 1) {
											_alert('网络超时')
										} else {
											_alert('用户取消')
										}
									}
								});
							} else {
								_loadingCloes();
								_alert('用户取消')
							}
						} else {
							_loadingCloes();
							if (erra.code == -1) {
								api.alert({
									msg: 'apiKey 或 registUrl 值非法'
								});
							} else if (erra.code == 1) {
								api.alert({
									msg: '用户取消'
								});
							} else if (erra.code == 2) {
								api.alert({
									msg: '发送失败'
								});
							} else if (erra.code == 3) {
								api.alert({
									msg: '授权失败'
								});
							} else if (erra.code == 4) {
								api.alert({
									msg: '不支持的请求'
								});
							} else if (erra.code == 5) {
								api.alert({
									msg: '未知错误'
								});
							}
						}
					});
				} else {
					_loadingCloes();
					api.alert({
						msg: '当前设备未安装新浪微博客户端'
					});
				}
			});
		} else if (type == 'jd') {
			var jd = api.require('jd');
			jd.login({}, function(ret, err) {
				if (ret) {
					var openid = ret.uid
					var img = ''
					var nickname = ret.nickname
					var info = ret
					_loginToken({
						type: 'jdapp',
						openid: openid,
						img: img,
						nickname: nickname,
						info: info
					})
				} else {
					_loadingCloes();
				}
			});
		}
	}
	// 封装ajax登录获取token
	function _loginToken(data) {
		_ajax('member/info', function(rets, errs) {
			if (rets) {
				if (ret.data) {
					_loadingCloes();
					$api.setStorage('user', ret.data);
					_msg('登录成功')
					api.sendEvent({
						name: 'ext',
						extra: {
							key1: 'value1',
						}
					});
					setTimeout(function() {
						_hone()
					}, 1000)
				} else {
					_loadingCloes()
					_alert(rets.err)
				}
			} else {
				_alert(JSON.stringify(errs))
			}
			},null,{auth:$api.getStorage('token')})
	}
</script>

</html>
