<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no" />
		<title>e乐享</title>
		<link rel="stylesheet" type="text/css" href="../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../css/login.css" />
	</head>
	<body>
		<div class="aui-content aui-margin-b-15 fx-yejian-by" style="padding-top: 50px;">
			<ul class="aui-list aui-form-list" id="login-1">
				<li class="aui-list-item" id="mobile">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-input">
							<input type="tel" placeholder="输入手机号码" value="">
						</div>
					</div>
				</li>
				<li class="aui-list-item" id="password" style="background: none">
					<div class="aui-list-item-inner" style="border-bottom: 0px;">
						<div class="aui-list-item-input">
							<input type="password" placeholder="设置新密码"  value="">
						</div>
					</div>
				</li>
				<li class="aui-list-item" id="yzm">
					<div class="aui-list-item-inner">
						<div class="aui-list-item-input">
							<input type="tel" placeholder="输入手机验证码" id="code" value="">
						</div>
						<div class="aui-list-item-label-icon fx-yzm" id="sendVerify" status='1' Tapmode onclick="getVerify()" >
							获取验证码
						</div>
					</div>
				</li>
				<li class="aui-list-item">
					<div class="aui-list-item-inner">
						<label style="margin:0 auto; font-size: 0.65rem;">
							<input class="aui-checkbox" type="checkbox" id="checkbox"  checked />
							我同意<a style=" font-size: 0.65rem;" href="javascript:;" tapmode onclick="_article({title:'用户协议和隐私条款',article_id:12})">"用户协议和隐私条款"</a> </label>
					</div>
				</li>
			</ul>
		</div>
		<div class="aui-content aui-margin-b-15 fx-login fx-yejian-by">
			<div class="aui-btn aui-btn-danger aui-btn-block aui-btn-sm" id="tijiao">
				注册
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../script/zepto.min.js"></script>
	<script type="text/javascript" src="../script/fastclick.js"></script>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/app.js"></script>
	<script type="text/javascript">
		apiready = function() {
			var openid = api.pageParam['openid'];
			var type = api.pageParam['type'];
			if (openid && type) {
				$api.text($api.dom('#tijiao'), '绑  定');
			} else {
				openid = '';
				type = '';
			}
			FastClick.attach(document.body)
			$('#tijiao').click(function() {
				var username = $('#mobile input').val();
				var password = $('#password input').val();
				var code = $('#code').val();
				if (!username) {
					_msg('手机号码不能空')
					return;
				}
				if (!_isMobile(username)) {
					_msg('请输入正确手机号码')
					return;
				}
				if (!password) {
					_msg('请设置新密码');
					return
				}
				if (!code) {
					_msg('手机验证码不能为空');
					return
				}
				var checkbox = $('#checkbox').is(':checked');
				if (checkbox == false) {
					_msg('请先同意服务条款')
					return false;
				}
				_loading();
				if (openid && type) {
					_ajax('user/reg', function(ret, err) {
						//	_msg('tokens:' + JSON.stringify(ret) + "\r\nerr:" + JSON.stringify(err))
						var tokens = ret.token;
						if (tokens) {
							_ajaxs('member/info', function(rets, errs) {
								//_msg('rets:' + JSON.stringify(rets) + "\r\nerrs:" + JSON.stringify(errs))
								if (rets.ret) {
									_loadingCloes();
									$api.setStorage('token', ret.ret);
									$api.setStorage('user', rets.ret);
									_msg('登录成功', function(retty) {
										if (retty) {
											_hone();
										}
									})
								} else {
									_loadingCloes();
									_msg(rets.err)
								}
							}, {
								token : tokens
							})
						} else {
							_loadingCloes();
							_msg(ret.err)
						}
					}, {
						username : username,
						password : password,
						code : code,
						type : type,
						token : openid
					})
				} else {
					_ajax('login/register', function(ret, err) {
						_loadingCloes();
						if(ret){
                            if (ret.status) {
                                _alert(ret.msg, function(ret) {
                                    _close()
                                })
                            } else {
                                _msg(ret.msg)
                            }
						}
					}, {
						username : username,
						password : password,
						code : code
					})
				}
			})
		}
		var smsVerify;
		function getVerify() {
			var mobileVal = $('#mobile input').val();
			if (!mobileVal) {
				_msg('请输入手机号码')
				return false;
			}
			if (!_isMobile(mobileVal)) {
				_msg('请输入正确手机号码')
				return;
			}
			var status = $('#sendVerify').attr('status');
			if (status != 1) {
				return;
			}
			_loading();
			_ajax('login/get_reg_sms_code', function(ret, err) {
				_loadingCloes()
				if (ret) {
					if (ret.status) {
						$("#sendVerify").html('<span id="GetVerify">120</span>S');
						times = 119;
						isinerval = setInterval("CountDown()", 1000);
						setTimeout(function() {
							_msg(ret.msg)
							$('#sendVerify').attr('status', '0');
						}, 500)
					} else {
						_msg(ret.msg)
					}
				} else {
					_msg(JSON.stringify(err))
				}
			}, {
				username : mobileVal,
				text : '注册'
			})
		}

		function CountDown() {
			if (times < 1) {
				var sendVerify = $('#sendVerify');
				$(sendVerify).attr('onclick', 'getVerify()');
				$(sendVerify).attr('status', '1');
				$(sendVerify).html('重新获取');
				clearInterval(isinerval);
				return;
			}
			var getVerify = $('#GetVerify');
			$(getVerify).html('' + times + '');
			times--;
		}

	</script>
</html>
