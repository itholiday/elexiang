<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no" />
		<title>e乐享</title>
		<link rel="stylesheet" type="text/css" href="../../css/core.css">
		<link rel="stylesheet" type="text/css" href="../../css/icon.css">
		<link rel="stylesheet" type="text/css" href="../../css/home.css">
	</head>
	<body>
	<script id="addressContent" type="text/x-dot-template">
		<div class="aui-address-box" tapmode data-data='{{= JSON.stringify(it.data) }}' data-id="{{= it.data.id }}" onclick="xiugai(this)" id="thisAddr">
			<div class="aui-address-box-list">
				<div class="aui-address-box-default">
					<ul>
						<li>
							<strong>{{=it.data.shouhuoren}} {{= it.data.mobile }}</strong>
							{{? it.data.mark }}
							<span class="aui-tag" id="aui-home">{{= it.data.mark }}</span>
							{{?}}
							{{? it.data.default=='Y'}}
							<span class="aui-tag aui-tag-default" id="aui-default">默认</span>
							{{?}}
						</li>
						<li>
							<i class="aui-icon aui-icon-address"></i>
							{{= it.data.shouhuodizhi}}
						</li>
					</ul>
				</div>
			</div>
		</div>
	</script>
	<div id="address">
		<!--在这里插入地址-->
	</div>

    <div class="aui-dri"></div>
	<script type="text/x-dot-template" id="shopContent">
		<div class="aui-list-product-fl-item">
			<div class="aui-list-product-fl-img">
				<img src="{{= sx_upload + it.thumb }}" alt="">
			</div>
			<div class="aui-list-product-fl-text">
				<h3 class="aui-list-product-fl-title">{{= it.title }}</h3>
				<div class="aui-list-product-fl-mes">
					<div>
						<span class="aui-list-product-item-price"> <em>¥</em> {{= Number(it.yunjiage).toFixed(2) }} </span>
						<span class="aui-list-product-item-del-price"> ¥ {{= Number(it.money).toFixed(2) }} </span>
					</div>
				</div>
			</div>
		</div>
	</script>
    <div class="aui-list-product-float-item" tapmode
         onclick="_url({title:'商品详情',goods_id:api.pageParam['goods_id'],url:'shop/shangpinxiangqing'})" id="shop">
    </div>
    <div class="aui-payment-bar">
        <div class="settlement aui-btn-info" tapmode onclick="apply()" style='background:red;'>提交申请</div>
    </div>
	</body>
		<script type="text/javascript" src="../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../script/api.js"></script>
		<script type="text/javascript" src="../../script/doT.js"></script>
		<script type="text/javascript" src="../../script/app.js"></script>
		<script type="text/javascript">
			var count = 0;
			apiready = function() {
				api.parseTapmode();
                viewShop();
                getAddress();
				_shangla(function (ret,err) {
                    viewShop();
                    getAddress();
                },1);
				api.addEventListener({
					name:'viewappear'
				},function (ret,err) {
                    viewShop();
                    getAddress();
                })
			};
			function getAddress(){
                _ajax('user/get_address_one',function(ret,err){
                    api.refreshHeaderLoadDone();
                    if(ret) {
                        if (!ret.status) {
                            if (!count) {
                                count++;
                                _url({url: 'user/dizhiAdd', title: '添加新地址'});
                            }
                        } else {
                            var evalData = doT.template($api.html($api.byId('addressContent')));
                            $api.html($api.byId('address'), evalData(ret));
                        }
                    }
                })
			}
			function viewShop(){
				_ajax('shop/goods_item',function(ret,err){
					if(ret){
					    if(ret.status){
                            var evalData = doT.template($api.html($api.byId('shopContent')));
                            $api.html($api.byId('shop'),evalData(ret.data));
						}
					}else{
						alert(JSON.stringify(err))
					}
				},{goods_id:api.pageParam['goods_id']})
			}
			function apply(){
                var addrid = $api.attr($api.byId('thisAddr'), 'data-id');
                var title =  '';
                var msg = '';
                if(!addrid){
					title = '您确认不添加收货地址吗？'
					msg = '不添加收货地址不允许申请发货哟！'
				}else{
					title = '您确认要提交吗？';
					msg = '申请提交后，将有客服和您联系，请保持电话畅通！';
				}
				api.confirm({
				    title: title,
				    msg:msg,
				    buttons: ['确定', '取消']
				}, function(ret, err) {
				    var index = ret.buttonIndex;
				    if(index==1){
				        if(!addrid){
				            _close();return;
						}
				        _ajax('member/apply_fahuo',function(ret,err){
                            if(ret){
                                if(ret.status){
                                    _msg('申请成功，请保持电话畅通！',3000);
									setTimeout(function(){
										_close();
									},2000)
                                }else{
                                    _msg(ret.msg);
									_url({url:'user/dizhi',title:'收货信息'})
                                }
                            }
                        },{goods_id:api.pageParam['goods_id'],addrid:addrid})
				    }
				});
			}
            function xiugai(thiss) {
                var data = $api.attr(thiss, 'data-data');
                var addrid = $api.attr(thiss, 'data-id');
                if (data) {
                    data = eval('(' + data + ')');
                    var json = {};
                    var json1 = data;
                    var json2 = {
                        url: 'user/dizhiAdd',
                        title: '修改地址',
						id:addrid
                    };
                    json = eval('(' + (JSON.stringify(json1) + JSON.stringify(json2)).replace(/}{/, ',') + ')');
                    data = json;
                }
                _url(data)
            }
		</script>
</html>
